# Telegram Bot для обработки файлов

Этот бот предназначен для обработки файлов (JSON и HTML) через интеграцию с Kafka и MinIO.

## Описание

Бот позволяет пользователям:
- Отправлять JSON и HTML файлы для обработки
- Объединять несколько HTML файлов в один
- Отслеживать статус обработки файлов
- Повторять обработку файлов при необходимости

При получении файла бот:
1. Сохраняет файл в MinIO
2. Отправляет задачу в Kafka для обработки
3. Ожидает результат обработки
4. Возвращает обработанный файл пользователю

## Функциональность

### Основные команды
- `/start` - начать работу с ботом
- `/status` - проверить статус системы
- `/tasks` - посмотреть свои задачи
- `/check <id>` - проверить статус конкретной задачи
- `/retry <id>` - повторить обработку задачи

### Работа с групповыми файлами
Для объединения нескольких HTML файлов в один:
- `/group_start` - начать сбор файлов
- Отправить HTML файлы (максимум 50)
- `/group_finish` - завершить сбор и объединить файлы
- `/group_cancel` - отменить сбор файлов
- `/group_status` - проверить статус сбора

## Технологии

### Фронтенд (Telegram бот)
- **Python 3.9+** - основной язык разработки
- **Aiogram** - фреймворк для работы с Telegram Bot API
- **Kafka** - система обмена сообщениями для передачи задач на обработку
- **MinIO** - объектное хранилище для файлов
- **SQLite** - локальная база данных для хранения состояния задач

### Бекенд (parsing_module)
- **Go 1.24.2** - основной язык разработки
- **Kafka** - система обмена сообщениями для получения задач и отправки результатов
- **MinIO** - объектное хранилище для загрузки и выгрузки файлов
- **GoQuery** - библиотека для парсинга HTML файлов
- **json-iterator/go** - библиотека для эффективной работы с JSON
- **Zillow Kafka** - клиент для работы с Kafka

## Настройка окружения

1. Создайте файл `.env` в корне проекта:
```bash
TELEGRAM_BOT_TOKEN=your_token_here
MINIO_ENDPOINT=localhost:9000
MINIO_ACCESS_KEY=minioadmin
MINIO_SECRET_KEY=minioadmin
MINIO_SECURE=False
MINIO_INPUT_BUCKET=input-files
MINIO_OUTPUT_BUCKET=output-files
KAFKA_BOOTSTRAP_SERVERS=localhost:9094
KAFKA_INPUT_TOPIC=INPUT
KAFKA_OUTPUT_TOPIC=OUTPUT
KAFKA_CONSUMER_GROUP=telegram-bot-group
PROCESSING_TIMEOUT=300
MAX_FILE_SIZE=209715200
STATE_DB_PATH=bot_state.db
MAX_GROUP_FILES=50
```

2. Установите зависимости:
```bash
pip install -r requirements.txt
```

## Запуск

```bash
python python/main.py
```

## Структура проекта

```
.
├── .env                    # Файл с переменными окружения
├── bot.log                 # Лог-файл бота
├── bot_state.db            # База данных состояния задач
├── docker-compose.yml      # Конфигурация для запуска зависимостей
├── parsing_module/         # Модуль обработки файлов (Go)
│   ├── Dockerfile          # Dockerfile для сборки образа
│   ├── go.mod              # Модуль Go
│   ├── go.sum              # Суммы зависимостей Go
│   ├── main.go             # Точка входа в приложение
│   ├── dto/                # Data Transfer Objects
│   │   ├── request_dto.go  # DTO для входящих запросов
│   │   ├── response_dto.go # DTO для исходящих ответов
│   │   └── telegram_dto.go # DTO для данных Telegram
│   ├── integration/        # Интеграция с внешними системами
│   │   ├── kafka_adapter.go # Адаптер для Kafka
│   │   └── minio_adapter.go # Адаптер для MinIO
│   ├── parsing/            # Модуль парсинга файлов
│   │   └── parser.go       # Основной парсер
│   ├── process/            # Процесс обработки
│   │   └── processor.go    # Процессор задач
│   └── utils/              # Утилиты
│       └── utils.go        # Вспомогательные функции
├── python/                 # Основной код бота (Python)
│   ├── main.py             # Основной модуль бота
│   └── simple_bot.py       # Простая версия бота
├── tasks.db                # База данных задач (устаревшая?)
└── venv/                   # Виртуальное окружение
```

## Переменные окружения

### Общие переменные (используются в обоих модулях)
| Переменная | Описание | Значение по умолчанию |
|-----------|---------|---------------------|
| `MINIO_ENDPOINT` | Адрес MinIO сервера | localhost:9000 |
| `MINIO_ACCESS_KEY` | Ключ доступа MinIO | minioadmin |
| `MINIO_SECRET_KEY` | Секретный ключ MinIO | minioadmin |
| `MINIO_SECURE` | Использовать HTTPS | False |
| `MINIO_INPUT_BUCKET` | Бакет для входящих файлов | input-files |
| `MINIO_OUTPUT_BUCKET` | Бакет для обработанных файлов | output-files |
| `KAFKA_BOOTSTRAP_SERVERS` | Адреса Kafka брокеров | localhost:9094 |
| `KAFKA_INPUT_TOPIC` | Топик для входящих задач | INPUT |
| `KAFKA_OUTPUT_TOPIC` | Топик для результатов | OUTPUT |
| `KAFKA_CONSUMER_GROUP` | Группа потребителей Kafka | telegram-bot-group |

### Переменные для Telegram бота (Python)
| Переменная | Описание | Значение по умолчанию |
|-----------|---------|---------------------|
| `TELEGRAM_BOT_TOKEN` | Токен Telegram бота | - |
| `PROCESSING_TIMEOUT` | Таймаут обработки в секундах | 300 |
| `MAX_FILE_SIZE` | Максимальный размер файла в байтах | 209715200 |
| `STATE_DB_PATH` | Путь к файлу базы данных состояния | bot_state.db |
| `MAX_GROUP_FILES` | Максимальное количество файлов в группе | 50 |

### Переменные для модуля обработки (Go)
| Переменная | Описание | Значение по умолчанию |
|-----------|---------|---------------------|
| `KAFKA_BOOTSTRAP` | Адрес Kafka брокера | kafka:9092 |
| `KAFKA_INPUT_TOPIC` | Топик для входящих задач | INPUT |
| `KAFKA_OUTPUT_TOPIC` | Топик для результатов | OUTPUT |
| `KAFKA_CONSUMER_GROUP` | Группа потребителей Kafka | parser |

## Обработка ошибок

### Telegram бот (Python)
Бот обрабатывает различные сценарии ошибок:
- Недоступность Kafka или MinIO
- Таймаут обработки файлов
- Повторные попытки отправки сообщений
- Восстановление состояния после перезапуска
- Автоматическая очистка устаревших сессий

При недоступности Kafka используется эмуляция обработки для демонстрации функциональности.

### Модуль обработки (Go)
Модуль обработки также обрабатывает ошибки:
- Ошибки при чтении файлов из MinIO
- Ошибки парсинга JSON и HTML файлов
- Ошибки при создании выходного CSV файла
- Ошибки при отправке результатов в Kafka
- Ошибки при работе с Kafka и MinIO

При возникновении ошибки модуль отправляет сообщение с деталями ошибки в выходной топик Kafka, чтобы Telegram бот мог уведомить пользователя.

